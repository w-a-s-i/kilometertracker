<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Kilometer Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#4CAF50">
<style>
body { font-family:sans-serif; margin:1rem; max-width:100%; }
.totals-text { font-size:1.5rem; font-weight:bold; text-align:center; margin-bottom:1rem; }
form { display:flex; flex-direction:column; gap:1rem; max-width:400px; margin:0 auto 1.5rem auto; }
input, button { padding:1rem; font-size:1.3rem; width:100%; box-sizing:border-box; }
#status { text-align:center; color:green; font-size:1.1rem; margin-bottom:1rem; }
table { width:100%; border-collapse:collapse; margin-bottom:1.5rem; }
table th, table td { border:1px solid #ccc; padding:14px 10px; text-align:center; line-height:1.6; }
table th { background-color:#f0f0f0; font-size:1.4rem; font-weight:bold; }
table td { font-size:1.4rem; }

/* === Filter Styling === */
.multi-select-container {
  border: 1px solid #ccc;
  padding: 8px;
  width: 100%;
  margin-bottom: 10px;
  border-radius: 6px;
  background: #fff;
  position: relative;
  user-select: none;
  cursor: pointer;
}

/* Options schieben Inhalt nach unten */
.multi-select-options {
  display: none;
  border-top: 1px solid #eee;
  max-height: 320px;
  overflow-y: auto;
  padding: 8px;
  background: #fff;
  width: 100%;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.multi-select-container.active .multi-select-options {
  display: grid;
}

.filter-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 10px;
  background: #f3f3f3;
  padding: 10px;
  font-weight: 500;
  border: none;
  cursor: pointer;
  transition: background 0.2s;
}

.filter-btn.active {
  background: #4caf50;
  color: #fff;
}

@media (max-width: 600px) {
  .multi-select-options {
    grid-template-columns: 1fr;
    max-height: 240px;
  }
}
</style>
</head>
<body>

<!-- Neue Tages- und Wochenwerte -->
<div id="dailyTotals">
  <p class="totals-text"><strong><span id="totalToday"></span> KM heute</strong></p>
  <p class="totals-text"><strong><span id="totalYesterday"></span> KM gestern</strong></p>
  <p class="totals-text"><strong><span id="totalLast7"></span> KM in 7 Tagen</strong></p>
</div>

<div id="totals">
  <p class="totals-text"><strong><span id="totalLast30"></span> KM in 30 Tagen</strong></p>
  <p class="totals-text"><strong><span id="totalLastYear"></span> KM in 365 Tagen</strong></p>
  <p class="totals-text"><strong><span id="totalSinceOct"></span> KM seit Oktober 2023</strong></p>
</div>

<form id="dataForm">
  <input type="date" id="date" required>
  <input type="text" id="name" placeholder="Name" required>
  <input type="number" id="km" placeholder="Kilometer" required>
  <button type="submit">Eintragen</button>
</form>

<div id="status"></div>

<table id="summary30Table"><thead><tr><th>Name</th><th>30 Tage</th></tr></thead><tbody></tbody></table>
<table id="summary365Table"><thead><tr><th>Name</th><th>365 Tage</th></tr></thead><tbody></tbody></table>
<table id="quarterlyTable"><thead><tr><th>Name</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th></tr></thead><tbody></tbody></table>

<div class="multi-select-container" id="nameFilterContainer">
  <div class="multi-select-options" id="nameFilterOptions"></div>
</div>

<table id="filteredTable"><thead><tr><th>Datum</th><th>Name</th><th>Kilometer</th></tr></thead><tbody></tbody></table>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbwKk6g-ZgH4j7CuNlY25MysSHIu-dQT47WPb2t1a2LKPnpQvaHm9L9XTTxd9va1yWWF7w/exec";
const form = document.getElementById("dataForm");
const statusDiv = document.getElementById("status");
const nameInput = document.getElementById("name");
const dateInput = document.getElementById("date");
const todayStr = new Date().toISOString().split('T')[0];
dateInput.value = todayStr;
dateInput.max = todayStr;

const gespeicherterName = localStorage.getItem("letzterName");
if (gespeicherterName) nameInput.value = gespeicherterName;

window.kmData = [];

// Datum korrekt parsen (DD.MM.YYYY oder ISO)
function parseDate(str) {
  const parts = str.split('.');
  if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
  return new Date(str);
}

form.addEventListener("submit", async e => {
  e.preventDefault();
  const newEntry = { date: dateInput.value, name: nameInput.value.trim(), km: parseFloat(document.getElementById("km").value) };
  const knownNames = new Set(window.kmData.map(d => d.Name));
  if (!knownNames.has(newEntry.name) && !confirm("Name unbekannt. Trotzdem eintragen?")) return;
  const duplicate = window.kmData.some(d => d.Datum.toISOString().split('T')[0] === newEntry.date && d.Name === newEntry.name && d.Kilometer === newEntry.km);
  if (duplicate && !confirm("Eintrag existiert bereits. Trotzdem eintragen?")) return;

  try {
    const res = await fetch(scriptURL, { method: "POST", body: JSON.stringify(newEntry) });
    const result = await res.json();
    if (result.result === "success") {
      localStorage.setItem("letzterName", newEntry.name);
      document.getElementById("km").value = "";
      statusDiv.textContent = "✅ Eintrag gespeichert. Tabelle wird aktualisiert...";
      loadStats();
      setTimeout(() => statusDiv.textContent = "", 3000);
    } else {
      statusDiv.textContent = "⚠️ Fehler beim Speichern!";
      setTimeout(() => statusDiv.textContent = "", 4000);
    }
  } catch (err) {
    console.error(err);
    statusDiv.textContent = "⚠️ Netzwerkfehler!";
    setTimeout(() => statusDiv.textContent = "", 4000);
  }
});

async function loadStats() {
  try {
    const res = await fetch(scriptURL);
    const rawData = await res.json();
    const rows = rawData.slice(1);

    const data = rows.map(r => ({
      Datum: parseDate(r[0]),
      Name: r[1],
      Kilometer: parseFloat(r[2])
    }));
    data.forEach(d => d.Datum.setHours(0, 0, 0, 0));
    window.kmData = data;

    const today = new Date(); today.setHours(0, 0, 0, 0);
    const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
    const last7 = new Date(today); last7.setDate(today.getDate() - 7);
    const last30 = new Date(today); last30.setDate(today.getDate() - 30);
    const last365 = new Date(today); last365.setDate(today.getDate() - 365);
    const oct2023 = new Date(2023, 9, 1);

    // Neue Tages-/Wochen-Werte
    document.getElementById("totalToday").textContent = data.filter(d => d.Datum.getTime() === today.getTime()).reduce((s, e) => s + e.Kilometer, 0);
    document.getElementById("totalYesterday").textContent = data.filter(d => d.Datum.getTime() === yesterday.getTime()).reduce((s, e) => s + e.Kilometer, 0);
    document.getElementById("totalLast7").textContent = data.filter(d => d.Datum >= last7).reduce((s, e) => s + e.Kilometer, 0);

    // Bestehende Summen
    document.getElementById("totalLast30").textContent = data.filter(d => d.Datum >= last30).reduce((s, e) => s + e.Kilometer, 0);
    document.getElementById("totalLastYear").textContent = data.filter(d => d.Datum >= last365).reduce((s, e) => s + e.Kilometer, 0);
    document.getElementById("totalSinceOct").textContent = data.filter(d => d.Datum >= oct2023).reduce((s, e) => s + e.Kilometer, 0);

    // Tabellen
    const summary30 = {};
    data.forEach(d => { if (d.Datum >= last30) summary30[d.Name] = (summary30[d.Name] || 0) + d.Kilometer; });
    const tbody30 = document.querySelector("#summary30Table tbody"); tbody30.innerHTML = "";
    Object.entries(summary30).sort((a, b) => b[1] - a[1]).forEach(([n, k]) => { const r = document.createElement("tr"); r.innerHTML = `<td>${n}</td><td>${k}</td>`; tbody30.appendChild(r); });

    const summary365 = {};
    data.forEach(d => { if (d.Datum >= last365) summary365[d.Name] = (summary365[d.Name] || 0) + d.Kilometer; });
    const tbody365 = document.querySelector("#summary365Table tbody"); tbody365.innerHTML = "";
    Object.entries(summary365).sort((a, b) => b[1] - a[1]).forEach(([n, k]) => { const r = document.createElement("tr"); r.innerHTML = `<td>${n}</td><td>${k}</td>`; tbody365.appendChild(r); });

    const quarterDays = 91, quarters = [];
    for (let i = 0; i < 4; i++) { const end = new Date(today); end.setDate(end.getDate() - i * quarterDays); const start = new Date(end); start.setDate(end.getDate() - quarterDays); quarters.push({ start, end }); }
    const quarterSummary = {};
    data.forEach(d => { quarters.forEach((q, i) => { if (d.Datum >= q.start && d.Datum < q.end) { if (!quarterSummary[d.Name]) quarterSummary[d.Name] = Array(4).fill(0); quarterSummary[d.Name][i] += d.Kilometer; } }); });
    const sortedQuarterData = Object.entries(quarterSummary).map(([n, kms]) => ({ name: n, kms })).sort((a, b) => b.kms[0] - a.kms[0]);
    const tbodyQuarter = document.querySelector("#quarterlyTable tbody"); tbodyQuarter.innerHTML = "";
    sortedQuarterData.forEach(e => { const r = document.createElement("tr"); r.innerHTML = `<td>${e.name}</td>` + e.kms.map(k => `<td>${k}</td>`).join(""); tbodyQuarter.appendChild(r); });

    // Filter mit Buttons
    const nameSet = Array.from(new Set(data.map(d => d.Name))).sort();
    const container = document.getElementById("nameFilterContainer");
    const optionsDiv = document.getElementById("nameFilterOptions");
    optionsDiv.innerHTML = "";

    const active30Names = new Set(data.filter(d => d.Datum >= last30).map(d => d.Name));

    nameSet.forEach(n => {
      const btn = document.createElement("button");
      btn.textContent = n;
      btn.className = "filter-btn";
      if (active30Names.has(n)) btn.classList.add("active");
      btn.addEventListener("click", e => {
        e.stopPropagation();
        btn.classList.toggle("active");
        updateFilteredTable();
      });
      optionsDiv.appendChild(btn);
    });

    container.addEventListener("click", e => {
      e.stopPropagation();
      container.classList.toggle("active");
    });
    document.body.addEventListener("click", () => container.classList.remove("active"));

    function updateFilteredTable() {
      const activeNames = Array.from(optionsDiv.querySelectorAll(".filter-btn.active")).map(b => b.textContent);
      const tbody = document.querySelector("#filteredTable tbody");
      tbody.innerHTML = "";
      data.filter(d => activeNames.includes(d.Name))
          .sort((a, b) => b.Datum - a.Datum)
          .forEach(e => {
            const r = document.createElement("tr");
            r.innerHTML = `<td>${e.Datum.toLocaleDateString('de-DE')}</td><td>${e.Name}</td><td>${e.Kilometer}</td>`;
            tbody.appendChild(r);
          });
    }

    updateFilteredTable();

  } catch (err) { console.error(err); }
}

loadStats();
</script>
</body>
</html>
